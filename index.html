<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SFX Mobile V11 - Full Dual Loop</title>
    <style>
        :root { --accent: #ff00ff; --accent2: #00ffff; --bg: #0f0f0f; --card: #1a1a1a; --text: #eee; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 550px; padding-bottom: 160px; }
        header { width: 100%; padding: 10px 0; text-align: center; color: var(--accent); font-weight: bold; font-size: 0.9rem; letter-spacing: 2px; }
        
        section { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; }
        .osc1-box { border-left: 6px solid var(--accent); }
        .osc2-box { border-left: 6px solid var(--accent2); }
        h3 { font-size: 0.75rem; color: #888; margin: 0 0 12px 0; text-transform: uppercase; }
        
        .control-group { margin-bottom: 10px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.8rem; }
        .val { font-family: monospace; font-weight: bold; }
        .v1 { color: var(--accent); } .v2 { color: var(--accent2); }

        select { width: 100%; padding: 8px; background: #333; color: white; border: none; border-radius: 6px; font-size: 0.9rem; margin-bottom: 8px; }
        input[type="range"] { width: 100%; height: 25px; background: transparent; appearance: none; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; height: 22px; width: 22px; border-radius: 50%; margin-top: -9px; border: 2px solid #fff; }

        .osc1-box input[type="range"]::-webkit-slider-thumb { background: var(--accent); }
        .osc2-box input[type="range"]::-webkit-slider-thumb { background: var(--accent2); }

        .mix-panel { background: #222; text-align: center; border: 2px solid #444; position: sticky; top: 0; z-index: 10; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .footer-controls { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(10,10,10,0.95); padding: 15px; display: flex; gap: 10px; border-top: 1px solid #333; z-index: 100; }
        button { flex: 1; padding: 15px; border-radius: 10px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-play { background: linear-gradient(45deg, var(--accent), var(--accent2)); color: white; }
        .btn-loop { background: #333; color: #888; }
        .btn-loop.active { background: #ff4400; color: white; box-shadow: 0 0 15px #ff4400; }
        .io-area { width: 100%; height: 140px; background: #000; color: #0f0; border-radius: 8px; padding: 10px; font-size: 0.7rem; margin-top: 10px; font-family: 'Courier New', monospace; line-height: 1.5; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <header>SFX DUAL ENGINE V11</header>

    <section class="mix-panel">
        <div class="control-group">
            <div class="label-row"><span class="v1">PINK (OSC1)</span><span>MASTER MIX</span><span class="v2">CYAN (OSC2)</span></div>
            <input type="range" id="mix" min="0" max="1" step="0.01" value="0.5">
            <div class="label-row"><span class="v1" id="mix-v1">50%</span><span></span><span class="v2" id="mix-v2">50%</span></div>
        </div>
    </section>

    <section class="osc1-box">
        <h3 class="v1">OSC 1 - Pink Parameters</h3>
        <select id="type"><option value="sine">Sine</option><option value="square">Square</option><option value="sawtooth" selected>Sawtooth</option><option value="triangle">Triangle</option><option value="noise">Noise</option></select>
        <div class="control-group"><div class="label-row"><span>Freq</span><span class="val v1" id="freq-val"></span></div><input type="range" id="freq" min="20" max="3000" value="440"></div>
        <div class="control-group"><div class="label-row"><span>Slide</span><span class="val v1" id="slide-val"></span></div><input type="range" id="slide" min="-1500" max="1500" value="0"></div>
        <div class="control-group"><div class="label-row"><span>Atk</span><span class="val v1" id="atk-val"></span></div><input type="range" id="atk" min="0" max="1" step="0.01" value="0.01"></div>
        <div class="control-group"><div class="label-row"><span>Dec</span><span class="val v1" id="dec-val"></span></div><input type="range" id="dec" min="0.01" max="1" step="0.01" value="0.2"></div>
        <div class="control-group"><div class="label-row"><span>Sus</span><span class="val v1" id="sus-val"></span></div><input type="range" id="sus" min="0" max="1" step="0.01" value="0.3"></div>
        <div class="control-group"><div class="label-row"><span>Rel</span><span class="val v1" id="rel-val"></span></div><input type="range" id="rel" min="0.01" max="2" step="0.01" value="0.5"></div>
        <div class="control-group"><div class="label-row"><span>LFO Rate</span><span class="val v1" id="lfoRate-val"></span></div><input type="range" id="lfoRate" min="0" max="60" step="0.1" value="0"></div>
        <div class="control-group"><div class="label-row"><span>LFO Depth</span><span class="val v1" id="lfoDepth-val"></span></div><input type="range" id="lfoDepth" min="0" max="1000" value="0"></div>
        <div class="control-group"><div class="label-row"><span>Dist</span><span class="val v1" id="dist-val"></span></div><input type="range" id="dist" min="0" max="100" value="0"></div>
        <div class="control-group"><div class="label-row"><span>Filter</span><span class="val v1" id="filter-val"></span></div><input type="range" id="filter" min="100" max="15000" value="15000"></div>
    </section>

    <section class="osc2-box">
        <h3 class="v2">OSC 2 - Cyan Parameters</h3>
        <select id="type2"><option value="sine">Sine</option><option value="square">Square</option><option value="sawtooth">Sawtooth</option><option value="triangle" selected>Triangle</option><option value="noise">Noise</option></select>
        <div class="control-group"><div class="label-row"><span>Freq</span><span class="val v2" id="freq2-val"></span></div><input type="range" id="freq2" min="20" max="3000" value="880"></div>
        <div class="control-group"><div class="label-row"><span>Slide</span><span class="val v2" id="slide2-val"></span></div><input type="range" id="slide2" min="-1500" max="1500" value="0"></div>
        <div class="control-group"><div class="label-row"><span>Atk</span><span class="val v2" id="atk2-val"></span></div><input type="range" id="atk2" min="0" max="1" step="0.01" value="0.01"></div>
        <div class="control-group"><div class="label-row"><span>Dec</span><span class="val v2" id="dec2-val"></span></div><input type="range" id="dec2" min="0.01" max="1" step="0.01" value="0.2"></div>
        <div class="control-group"><div class="label-row"><span>Sus</span><span class="val v2" id="sus2-val"></span></div><input type="range" id="sus2" min="0" max="1" step="0.01" value="0.3"></div>
        <div class="control-group"><div class="label-row"><span>Rel</span><span class="val v2" id="rel2-val"></span></div><input type="range" id="rel2" min="0.01" max="2" step="0.01" value="0.5"></div>
        <div class="control-group"><div class="label-row"><span>LFO Rate</span><span class="val v2" id="lfoRate2-val"></span></div><input type="range" id="lfoRate2" min="0" max="60" step="0.1" value="0"></div>
        <div class="control-group"><div class="label-row"><span>LFO Depth</span><span class="val v2" id="lfoDepth2-val"></span></div><input type="range" id="lfoDepth2" min="0" max="1000" value="0"></div>
        <div class="control-group"><div class="label-row"><span>Dist</span><span class="val v2" id="dist2-val"></span></div><input type="range" id="dist2" min="0" max="100" value="0"></div>
        <div class="control-group"><div class="label-row"><span>Filter</span><span class="val v2" id="filter2-val"></span></div><input type="range" id="filter2" min="100" max="15000" value="15000"></div>
    </section>

    <section>
        <button style="background:#444; color:white; width:100%;" onclick="exportCode()">üìã EXPORT FUNCTION CODE</button>
        <textarea id="io-area" class="io-area" readonly></textarea>
    </section>
</div>

<div class="footer-controls">
    <button class="btn-loop" id="loopBtn" onclick="toggleLoop()">LOOP: OFF</button>
    <button class="btn-play" onclick="playSFX()">PLAY SFX</button>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isLooping = false, loopTimer = null;

    function updateDisplay() {
        document.querySelectorAll('input[type="range"]').forEach(input => {
            const valEl = document.getElementById(input.id + '-val');
            if(valEl) valEl.textContent = input.value;
        });
        const m = document.getElementById('mix').value;
        document.getElementById('mix-v1').textContent = Math.round((1-m)*100) + "%";
        document.getElementById('mix-v2').textContent = Math.round(m*100) + "%";
    }
    document.querySelectorAll('input').forEach(el => el.addEventListener('input', updateDisplay));
    updateDisplay();

    function makeDistortionCurve(amount) {
        let k = amount, n = 44100, c = new Float32Array(n);
        for (let i = 0; i < n; ++i ) {
            let x = i * 2 / n - 1;
            c[i] = (3 + k) * x * 20 * (Math.PI / 180) / (Math.PI + k * Math.abs(x));
        }
        return c;
    }

    function toggleLoop() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        isLooping = !isLooping;
        const btn = document.getElementById('loopBtn');
        btn.classList.toggle('active', isLooping);
        btn.textContent = isLooping ? "LOOP: ON" : "LOOP: OFF";
        if(isLooping) startLoop(); else clearTimeout(loopTimer);
    }

    function startLoop() {
        if(!isLooping) return;
        const s = getSettings();
        playSFX();
        const nextTime = Math.max(s.atk + s.dec + s.rel, s.atk2 + s.dec2 + s.rel2) * 1000 + 100;
        loopTimer = setTimeout(startLoop, nextTime);
    }

    function playSFX() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const s = getSettings(), now = audioCtx.currentTime;
        if(s.mix < 1) playEngine(s, "", (1-s.mix)*0.5, now);
        if(s.mix > 0) playEngine(s, "2", s.mix*0.5, now);
    }

    function playEngine(s, suffix, vol, now) {
        const type = s['type'+suffix], freq = s['freq'+suffix], slide = s['slide'+suffix];
        const atk = s['atk'+suffix], dec = s['dec'+suffix], sus = s['sus'+suffix], rel = s['rel'+suffix];
        const lfoR = s['lfoRate'+suffix], lfoD = s['lfoDepth'+suffix];
        const dist = s['dist'+suffix], filt = s['filter'+suffix];

        const g = audioCtx.createGain(), f = audioCtx.createBiquadFilter(), d = audioCtx.createWaveShaper();
        f.frequency.setValueAtTime(filt, now);
        d.curve = makeDistortionCurve(dist);

        let src;
        if(type === 'noise') {
            src = audioCtx.createBufferSource();
            const b = audioCtx.createBuffer(1, audioCtx.sampleRate, audioCtx.sampleRate);
            const data = b.getChannelData(0);
            for (let i = 0; i < b.length; i++) data[i] = Math.random() * 2 - 1;
            src.buffer = b;
        } else {
            src = audioCtx.createOscillator(); src.type = type;
            src.frequency.setValueAtTime(freq, now);
            src.frequency.exponentialRampToValueAtTime(Math.max(1, freq + slide), now + atk + rel);
            if (lfoR > 0) {
                const l = audioCtx.createOscillator(), lg = audioCtx.createGain();
                l.frequency.value = lfoR; lg.gain.value = lfoD;
                l.connect(lg); lg.connect(src.frequency);
                l.start(); l.stop(now + atk + rel + 0.1);
            }
        }
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(vol, now + atk);
        g.gain.linearRampToValueAtTime(sus * vol, now + atk + dec);
        g.gain.exponentialRampToValueAtTime(0.001, now + atk + dec + rel);

        src.connect(d); d.connect(f); f.connect(g); g.connect(audioCtx.destination);
        src.start(now); src.stop(now + atk + dec + rel + 0.1);
    }

    function getSettings() {
        const ids = ['mix','type','freq','slide','atk','dec','sus','rel','lfoRate','lfoDepth','dist','filter','type2','freq2','slide2','atk2','dec2','sus2','rel2','lfoRate2','lfoDepth2','dist2','filter2'];
        let config = {};
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) config[id] = isNaN(parseFloat(el.value)) ? el.value : parseFloat(el.value);
        });
        return config;
    }

    function exportCode() {
        const s = getSettings();
        
        // „Ç∑„É≥„Éó„É´„Å™Èñ¢Êï∞ÂΩ¢Âºè„ÅßÂá∫Âäõ
        const code = `        function playSFX() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioCtx.currentTime;
            const p = ${JSON.stringify(s)};
            
            // OSC1
            if(p.mix < 1) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                const filter = audioCtx.createBiquadFilter();
                
                osc.type = p.type;
                osc.frequency.setValueAtTime(p.freq, now);
                osc.frequency.exponentialRampToValueAtTime(Math.max(1, p.freq + p.slide), now + p.atk + p.rel);
                
                filter.frequency.setValueAtTime(p.filter, now);
                
                const vol = (1 - p.mix) * 0.5;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(vol, now + p.atk);
                gain.gain.linearRampToValueAtTime(p.sus * vol, now + p.atk + p.dec);
                gain.gain.exponentialRampToValueAtTime(0.001, now + p.atk + p.dec + p.rel);
                
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(now);
                osc.stop(now + p.atk + p.dec + p.rel + 0.1);
            }
            
            // OSC2
            if(p.mix > 0) {
                const osc2 = audioCtx.createOscillator();
                const gain2 = audioCtx.createGain();
                const filter2 = audioCtx.createBiquadFilter();
                
                osc2.type = p.type2;
                osc2.frequency.setValueAtTime(p.freq2, now);
                osc2.frequency.exponentialRampToValueAtTime(Math.max(1, p.freq2 + p.slide2), now + p.atk2 + p.rel2);
                
                filter2.frequency.setValueAtTime(p.filter2, now);
                
                const vol2 = p.mix * 0.5;
                gain2.gain.setValueAtTime(0, now);
                gain2.gain.linearRampToValueAtTime(vol2, now + p.atk2);
                gain2.gain.linearRampToValueAtTime(p.sus2 * vol2, now + p.atk2 + p.dec2);
                gain2.gain.exponentialRampToValueAtTime(0.001, now + p.atk2 + p.dec2 + p.rel2);
                
                osc2.connect(filter2);
                filter2.connect(gain2);
                gain2.connect(audioCtx.destination);
                osc2.start(now);
                osc2.stop(now + p.atk2 + p.dec2 + p.rel2 + 0.1);
            }
        }`;

        const ioArea = document.getElementById('io-area');
        ioArea.value = code;

        // iPhone/iPadÂØæÂøú„ÅÆ„Ç≥„Éî„ÉºÂá¶ÁêÜ
        copyToClipboard(code, ioArea);
    }

    function copyToClipboard(text, textArea) {
        // ÊñπÊ≥ï1: „É¢„ÉÄ„É≥„Å™Clipboard API (iOS 13.4+)
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                showToast("‚úÖ „Ç≥„Éî„ÉºÂÆå‰∫ÜÔºÅ");
            }).catch(err => {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                iosCopyFallback(textArea);
            });
        } else {
            // ÊñπÊ≥ï2: iOSÂêë„Åë„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            iosCopyFallback(textArea);
        }
    }

    function iosCopyFallback(textArea) {
        // iOS„ÅßÁ¢∫ÂÆü„Å´Âãï‰Ωú„Åô„ÇãÊñπÊ≥ï
        textArea.focus();
        textArea.select();
        
        // iOS„Åß„ÅØsetSelectionRange„ÅåÂøÖË¶Å
        try {
            const range = document.createRange();
            range.selectNodeContents(textArea);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            textArea.setSelectionRange(0, 999999);
        } catch(err) {
            console.log('Selection error:', err);
        }

        // execCommand„Åß„Ç≥„Éî„Éº
        let success = false;
        try {
            success = document.execCommand('copy');
        } catch(err) {
            console.log('Copy error:', err);
        }

        if(success) {
            showToast("‚úÖ „Ç≥„Éî„ÉºÂÆå‰∫ÜÔºÅ");
        } else {
            showToast("üìã Èï∑Êäº„Åó„Åß„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        }
        
        // ÈÅ∏Êäû„ÇíËß£Èô§
        window.getSelection().removeAllRanges();
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.cssText = `
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, var(--accent), var(--accent2));
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(255,0,255,0.5);
            font-size: 0.9rem;
            pointer-events: none;
        `;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.transition = 'opacity 0.5s, transform 0.5s';
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(-50%) translateY(10px)';
            setTimeout(() => {
                if(toast.parentNode) document.body.removeChild(toast);
            }, 500);
        }, 2000);
    }
</script>
</body>
</html>
