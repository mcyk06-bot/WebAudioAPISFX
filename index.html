<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SFX Mobile V5 - Full Pro</title>
    <style>
        :root { --accent: #00ffcc; --bg: #121212; --card: #1e1e1e; --text: #eee; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
        }
        .container { width: 100%; max-width: 500px; padding-bottom: 120px; }
        header { width: 100%; padding: 15px 0; text-align: center; color: var(--accent); font-weight: bold; letter-spacing: 2px; }
        
        section { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #333; }
        h3 { font-size: 0.75rem; color: #888; margin: 0 0 12px 0; text-transform: uppercase; border-left: 3px solid var(--accent); padding-left: 8px; }

        .control-group { margin-bottom: 15px; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.85rem; }
        .val { color: var(--accent); font-family: monospace; }

        select { width: 100%; padding: 10px; background: #333; color: white; border: none; border-radius: 8px; font-size: 1rem; margin-bottom: 10px; }

        input[type="range"] { width: 100%; height: 30px; background: transparent; appearance: none; }
        input[type="range"]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #444; border-radius: 2px; }
        input[type="range"]::-webkit-slider-thumb { appearance: none; height: 24px; width: 24px; background: var(--accent); border-radius: 50%; margin-top: -10px; }

        .footer-controls {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: rgba(18,18,18,0.95); padding: 15px;
            display: flex; gap: 10px; border-top: 1px solid #333; z-index: 100;
        }
        button { flex: 1; padding: 15px; border-radius: 10px; border: none; font-weight: bold; font-size: 0.9rem; }
        .btn-play { background: var(--accent); color: #000; }
        .btn-loop { background: #333; color: #888; }
        .btn-loop.active { background: #ff4400; color: white; }
        
        #export-area { width: 100%; height: 100px; background: #000; color: #0f0; border-radius: 8px; padding: 10px; font-size: 0.7rem; margin-top: 10px; border: 1px solid #333; }
    </style>
</head>
<body>

<div class="container">
    <header>SFX MACHINE MOBILE V5</header>

    <section>
        <h3>Oscillator & Pitch</h3>
        <select id="type">
            <option value="sine">Sine</option><option value="square">Square</option>
            <option value="sawtooth">Sawtooth</option><option value="triangle">Triangle</option>
            <option value="noise">Noise</option>
        </select>
        <div class="control-group">
            <div class="label-row"><span>Frequency</span><span class="val" id="freq-val"></span></div>
            <input type="range" id="freq" min="20" max="3000" value="440">
        </div>
        <div class="control-group">
            <div class="label-row"><span>Pitch Slide</span><span class="val" id="slide-val"></span></div>
            <input type="range" id="slide" min="-1500" max="1500" value="0">
        </div>
    </section>

    <section>
        <h3>ADSR Envelope</h3>
        
        <div class="control-group">
            <div class="label-row"><span>Attack</span><span class="val" id="atk-val"></span></div>
            <input type="range" id="atk" min="0" max="1" step="0.01" value="0.01">
        </div>
        <div class="control-group">
            <div class="label-row"><span>Decay</span><span class="val" id="dec-val"></span></div>
            <input type="range" id="dec" min="0.01" max="1" step="0.01" value="0.2">
        </div>
        <div class="control-group">
            <div class="label-row"><span>Sustain</span><span class="val" id="sus-val"></span></div>
            <input type="range" id="sus" min="0" max="1" step="0.01" value="0.3">
        </div>
        <div class="control-group">
            <div class="label-row"><span>Release</span><span class="val" id="rel-val"></span></div>
            <input type="range" id="rel" min="0.01" max="2" step="0.01" value="0.5">
        </div>
    </section>

    <section>
        <h3>LFO (Vibrato)</h3>
        <div class="control-group">
            <div class="label-row"><span>Rate (Speed)</span><span class="val" id="lfoRate-val"></span></div>
            <input type="range" id="lfoRate" min="0" max="60" step="0.1" value="0">
        </div>
        <div class="control-group">
            <div class="label-row"><span>Depth</span><span class="val" id="lfoDepth-val"></span></div>
            <input type="range" id="lfoDepth" min="0" max="1000" value="0">
        </div>
    </section>

    <section>
        <h3>Effects & Space</h3>
        <div class="control-group">
            <div class="label-row"><span>Distortion</span><span class="val" id="dist-val"></span></div>
            <input type="range" id="dist" min="0" max="100" value="0">
        </div>
        <div class="control-group">
            <div class="label-row"><span>Lowpass Filter</span><span class="val" id="filter-val"></span></div>
            <input type="range" id="filter" min="100" max="15000" value="15000">
        </div>
        <div class="control-group">
            <div class="label-row"><span>Delay Time</span><span class="val" id="delTime-val"></span></div>
            <input type="range" id="delTime" min="0" max="1" step="0.01" value="0">
        </div>
        <div class="control-group">
            <div class="label-row"><span>Delay Feedback</span><span class="val" id="delFeed-val"></span></div>
            <input type="range" id="delFeed" min="0" max="0.9" step="0.01" value="0.3">
        </div>
        <div class="control-group">
            <div class="label-row"><span>Reverb</span><span class="val" id="verb-val"></span></div>
            <input type="range" id="verb" min="0" max="1" step="0.01" value="0">
        </div>
    </section>

    <section>
        <button style="background:#444; color:white; width:100%;" onclick="exportCode()">EXPORT CODE</button>
        <textarea id="export-area" readonly></textarea>
    </section>
</div>

<div class="footer-controls">
    <button class="btn-loop" id="loopBtn" onclick="toggleLoop()">LOOP: OFF</button>
    <button class="btn-play" onclick="playSFX()">SHOT</button>
</div>

<script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let isLooping = false, loopTimer = null, currentNodes = null;

    function updateDisplay() {
        document.querySelectorAll('input[type="range"]').forEach(input => {
            document.getElementById(input.id + '-val').textContent = input.value;
        });
        if(currentNodes && isLooping) applyRealtimeParams();
    }
    document.querySelectorAll('input').forEach(el => el.addEventListener('input', updateDisplay));
    updateDisplay();

    function applyRealtimeParams() {
        const s = getSettings(), now = audioCtx.currentTime;
        if(currentNodes.osc) currentNodes.osc.frequency.setTargetAtTime(s.freq, now, 0.05);
        if(currentNodes.filter) currentNodes.filter.frequency.setTargetAtTime(s.filter, now, 0.05);
    }

    function toggleLoop() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        isLooping = !isLooping;
        const btn = document.getElementById('loopBtn');
        btn.classList.toggle('active', isLooping);
        btn.textContent = isLooping ? "LOOP: ON" : "LOOP: OFF";
        if(isLooping) startLoop(); else clearTimeout(loopTimer);
    }

    function startLoop() {
        if(!isLooping) return;
        const s = getSettings();
        playSFX();
        loopTimer = setTimeout(startLoop, (s.atk + s.dec + s.rel) * 1000 + 50);
    }

    function playSFX() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const s = getSettings(), now = audioCtx.currentTime;
        const g = audioCtx.createGain(), f = audioCtx.createBiquadFilter(), d = audioCtx.createWaveShaper();
        f.frequency.setValueAtTime(s.filter, now);
        d.curve = makeDistortionCurve(s.dist);

        let src;
        if (s.type === 'noise') {
            src = audioCtx.createBufferSource();
            const b = audioCtx.createBuffer(1, audioCtx.sampleRate * 2, audioCtx.sampleRate);
            const data = b.getChannelData(0);
            for (let i = 0; i < b.length; i++) data[i] = Math.random() * 2 - 1;
            src.buffer = b;
        } else {
            src = audioCtx.createOscillator(); src.type = s.type;
            src.frequency.setValueAtTime(s.freq, now);
            src.frequency.exponentialRampToValueAtTime(Math.max(1, s.freq + s.slide), now + s.atk + s.dec + s.rel);
            if (s.lfoRate > 0) {
                const l = audioCtx.createOscillator(), lg = audioCtx.createGain();
                l.frequency.value = s.lfoRate; lg.gain.value = s.lfoDepth;
                l.connect(lg); lg.connect(src.frequency);
                l.start(); l.stop(now + 3);
            }
        }

        const dur = s.atk + s.dec + s.rel;
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(0.4, now + s.atk);
        g.gain.linearRampToValueAtTime(s.sus * 0.4, now + s.atk + s.dec);
        g.gain.exponentialRampToValueAtTime(0.0001, now + dur);

        src.connect(d); d.connect(f); f.connect(g); g.connect(audioCtx.destination);

        if (s.delTime > 0) {
            const dl = audioCtx.createDelay(), df = audioCtx.createGain();
            dl.delayTime.value = s.delTime; df.gain.value = s.delFeed;
            g.connect(dl); dl.connect(df); df.connect(dl); dl.connect(audioCtx.destination);
        }
        if (s.verb > 0) {
            const v = audioCtx.createConvolver(); v.buffer = createReverbBuffer(s.verb);
            g.connect(v); v.connect(audioCtx.destination);
        }

        src.start(); src.stop(now + dur + 1);
        currentNodes = { osc: (s.type !== 'noise' ? src : null), filter: f };
    }

    function makeDistortionCurve(amount) {
        let k = amount, n = 44100, c = new Float32Array(n);
        for (let i = 0; i < n; ++i ) {
            let x = i * 2 / n - 1;
            c[i] = (3 + k) * x * 20 * (Math.PI / 180) / (Math.PI + k * Math.abs(x));
        }
        return c;
    }

    function createReverbBuffer(amount) {
        const len = audioCtx.sampleRate * 2;
        const b = audioCtx.createBuffer(2, len, audioCtx.sampleRate);
        for (let c = 0; c < 2; c++) {
            const d = b.getChannelData(c);
            for (let i = 0; i < len; i++) d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, 10 * amount);
        }
        return b;
    }

    function getSettings() {
        const ids = ['type','freq','slide','lfoRate','lfoDepth','atk','dec','sus','rel','dist','filter','delTime','delFeed','verb'];
        let config = {};
        ids.forEach(id => {
            const el = document.getElementById(id);
            config[id] = isNaN(parseFloat(el.value)) ? el.value : parseFloat(el.value);
        });
        return config;
    }

    function exportCode() {
        const s = getSettings();
        document.getElementById('export-area').value = `function playSFX(ctx) {
    const now = ctx.currentTime;
    const g = ctx.createGain(), f = ctx.createBiquadFilter();
    f.frequency.value = ${s.filter};
    let src;
    if("${s.type}"==="noise"){
        src=ctx.createBufferSource(); let b=ctx.createBuffer(1,ctx.sampleRate*2,ctx.sampleRate);
        let data=b.getChannelData(0); for(let i=0;i<b.length;i++)data[i]=Math.random()*2-1; src.buffer=b;
    } else {
        src=ctx.createOscillator(); src.type="${s.type}";
        src.frequency.setValueAtTime(${s.freq},now);
        src.frequency.exponentialRampToValueAtTime(${Math.max(1, s.freq + s.slide)}, now + ${s.atk + s.dec + s.rel});
        ${s.lfoRate > 0 ? `let l=ctx.createOscillator(),lg=ctx.createGain();l.frequency.value=${s.lfoRate};lg.gain.value=${s.lfoDepth};l.connect(lg);lg.connect(src.frequency);l.start();l.stop(now+3);`:''}
    }
    g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(0.4,now+${s.atk});
    g.gain.linearRampToValueAtTime(${s.sus*0.4},now+${s.atk+s.dec});
    g.gain.exponentialRampToValueAtTime(0.0001,now+${s.atk + s.dec + s.rel});
    src.connect(f); f.connect(g); g.connect(ctx.destination);
    ${s.delTime > 0 ? `let dl=ctx.createDelay(),df=ctx.createGain();dl.delayTime.value=${s.delTime};df.gain.value=${s.delFeed};g.connect(dl);dl.connect(df);df.connect(dl);dl.connect(ctx.destination);`:''}
    src.start(); src.stop(now + ${s.atk + s.dec + s.rel + 1});
}`;
    }
</script>

</body>
</html>